version: 2.1

jobs:
    build:
        machine:
            image: ubuntu-1604:201903-01
        environment:
            HOST_USER_IDS: "1001:1002"
        steps:
            - checkout
            - run:
                name: Create "proxy" Docker network (ignore if it already exists)
                command: docker network create proxy || true
            - run:
                name: Build docker images
                command: make build-dev
            - run:
                name: Archive Docker images
                command: |
                    docker save -o api-image.tar carcel/skeleton/dev:php
                    docker save -o client-image.tar carcel/skeleton/dev:node
            - run:
                name: Create cache directory for API dependencies
                command: mkdir -p ~/.cache/composer
            - run:
                name: Create configuration directory for API dependencies
                command: mkdir -p ~/.config/composer
            - restore_cache:
                keys:
                    - composer-v1-{{ checksum "api/composer.lock" }}
                    - composer-v1-
            - run:
                name: Create Yarn file and folders for configuration and cache
                command: |
                    touch ~/.yarnrc
                    mkdir ~/.yarn
                    mkdir -p ~/.cache/yarn
            - restore_cache:
                keys:
                    - node-v1-{{ checksum "client/yarn.lock" }}
                    - node-v1-
            - run:
                name: Install both API and client dependencies
                command: make install-dependencies
            - save_cache:
                key: composer-v1-{{ checksum "api/composer.lock" }}
                paths:
                    - ~/.cache/composer
            - save_cache:
                key: node-v1-{{ checksum "client/yarn.lock" }}
                paths:
                    - ~/.cache/yarn
            - persist_to_workspace:
                root: ~/
                paths:
                    - project
                    - api-image.tar
                    - client-image.tar
    test:
        machine:
            image: ubuntu-1604:201903-01
        environment:
            HOST_USER_IDS: "1001:1002"
        steps:
            - run:
                name: Create "proxy" Docker network (ignore if it already exists)
                command: docker network create proxy || true
            - attach_workspace:
                at: ~/
            - run:
                name: Load archived Docker images
                command: |
                    docker load -i api-image.tar
                    docker load -i client-image.tar
            - run:
                name: Create Yarn file and folders for configuration and cache
                command: |
                    touch ~/.yarnrc
                    mkdir ~/.yarn
                    mkdir -p ~/.cache/yarn
            - run:
                name: Run static analysis on the API
                command: make check-style-api
            - run:
                name: Run coupling detector on the API
                command: make coupling-api
            - run:
                name: Run unit tests of the API
                command: make unit-api
            - run:
                name: Run acceptance tests of the API
                command: make acceptance-api
            - run:
                name: start MySQL container
                command: cd ~/project/api && docker-compose up -d mysql
            - run:
                name: Update database schema
                command: make mysql
            - run:
                name: Run integration tests on the API
                command: make integration-api
            - run:
                name: Run end to end tests on the API
                command: make end-to-end-api
            - run:
                name: Run static analysis on the client application
                command: make check-style-client
            - run:
                name: Type-check the client application
                command: make type-check-client
            - store_test_results:
                path: client/tests/results
            - store_artifacts:
                path: client/tests/results
            - store_test_results:
                path: api/tests/results
            - store_artifacts:
                path: api/tests/results

workflows:
    version: 2
    pull_request:
        jobs:
            - build:
                  filters:
                      branches:
                          ignore:
                              - master
            - test:
                requires:
                    - build
    weekly:
        triggers:
            - schedule:
                cron: "0 0 * * 1"
                filters:
                    branches:
                        only:
                            - master
        jobs:
            - build
            - test:
                requires:
                    - build
