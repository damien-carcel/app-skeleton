version: 2

jobs:
    build:
        machine:
            enabled: true
            docker_layer_caching: true
        environment:
            CURRENT_IDS: "1001:1002"
        steps:
            - checkout
            - run:
                name: Build front-end docker images
                command: cd ~/project/front && docker-compose build --pull node
            - run:
                name: Copy docker-compose override for front-end
                command: cp ~/project/.circleci/front/docker-compose.override.yaml.dist ~/project/front/docker-compose.override.yaml
            - run:
                name: Create cache directory for front-end dependencies
                command: mkdir -p ~/.cache/yarn
            - run:
                name: Create yarnrc if not already present
                command: touch ~/.yarnrc
            - restore_cache:
                keys:
                    - node-v1-{{ checksum "front/yarn.lock" }}
                    - node-v1-
            - run:
                name: Install front-end dependencies
                command: cd ~/project/front && docker-compose run --rm node yarn install
            - save_cache:
                key: node-v1-{{ checksum "front/yarn.lock" }}
                paths:
                    - ~/.cache/yarn
            - restore_cache:
                keys:
                    - composer-v1-{{ checksum "back/composer.lock" }}
                    - composer-v1-
            - run:
                name: Build back-end docker images
                command: cd ~/project/back && docker-compose build --pull php
            - run:
                name: Copy docker-compose override for back-end
                command: cp ~/project/.circleci/back/docker-compose.override.yaml.dist ~/project/back/docker-compose.override.yaml
            - run:
                name: Create cache directory for back-end dependencies
                command: mkdir -p ~/.cache/composer
            - run:
                name: Create configuration directory for back-end dependencies
                command: mkdir -p ~/.config/composer
            - run:
                name: Install back-end dependencies
                command: cd ~/project/back && docker-compose run --rm php composer install --prefer-dist --optimize-autoloader --no-interaction --no-scripts
            - save_cache:
                key: composer-v1-{{ checksum "back/composer.lock" }}
                paths:
                    - ~/.cache/composer
            - persist_to_workspace:
                    root: ~/
                    paths:
                        - project
    front_end_static_and_unit_tests:
        machine:
            enabled: true
            docker_layer_caching: true
        steps:
            - attach_workspace:
                at: ~/
            - run:
                name: Run static analysis on the front-end application
                command: cd ~/project/front && docker-compose run --rm node yarn run lint
            - run:
                name: Type-check the front-end application
                command: cd ~/project/front && docker-compose run --rm node yarn run type-check
    back_end_static_and_unit_tests:
        machine:
            enabled: true
            docker_layer_caching: true
        steps:
            - attach_workspace:
                at: ~/
            - run:
                name: Run static analysis on the back-end application
                command: cd ~/project/back && docker-compose run --rm php vendor/bin/php-cs-fixer fix --dry-run -v --diff --config=.php_cs.php
            - run:
                name: Run static analysis on the unit tests of the back-end application
                command: cd ~/project/back && docker-compose run --rm php vendor/bin/php-cs-fixer fix --dry-run -v --diff --config=.php_cs.phpspec.php
            - run:
                name: Run unit tests of the back-end application
                command: cd ~/project/back && docker-compose run --rm php vendor/bin/phpspec run

workflows:
    version: 2
    pull_request:
        jobs:
            - wait_for_user_approval:
                type: approval
                filters:
                    branches:
                        ignore:
                            - master
            - build:
                requires:
                    - wait_for_user_approval
            - front_end_static_and_unit_tests:
                requires:
                    - build
            - back_end_static_and_unit_tests:
                requires:
                    - build
    nightly:
        triggers:
            - schedule:
                cron: "0 2 * * *"
                filters:
                    branches:
                        only:
                            - master
        jobs:
            - build
            - front_end_static_and_unit_tests:
                requires:
                    - build
            - back_end_static_and_unit_tests:
                requires:
                    - build

